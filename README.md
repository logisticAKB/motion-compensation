# motion-compensation

#### 1. Подготовить видео сконвертировав mp4 в сырое видео:
 `ffmpeg -v error -i sample1.mp4 -pix_fmt yuv420p -f rawvideo -an -sn sample1.yuv420p`

#### 2. В файле `main.cpp` указать пути, размер кадра, кол-во потоков, тип поиска, выводить или нет PSNR

#### 3. Скомпилировать и запустить проект 
 - Ubuntu
   - `mkdir build && cd build`
   - `cmake ..`
   - `make`
   - `./motion_compensation`
 - Windows
   - Собирается и запускается в Visual Studio
   - Обязательно выставить в `CMakeSettings.json` строчку `"configurationType": "Release"`. В дебаге будет крашить на строчке `delete[]` в деструкторе класса `Frame`. Ругается на повреждение кучи. Разрабатывал на Linux, увидел это поздно, когда решил протестировать под Windows. Но никаких утечек памяти не наблюдается. Возможно стоило использовать умные указатели заместо обычных.

#### 3. После завершения работы программы можно сконвертировать сырой результат в mp4 
`ffmpeg -f rawvideo -vcodec rawvideo -s 1920x1080 -r 30 -pix_fmt yuv420p -i sample1.yuv420p -c:v libx264 -preset slow -qp 0 output.mp4`

#### Видео, на которых тестировал, а так же результаты работы можно посмотреть [тут](https://drive.google.com/drive/folders/1RSoGfxYdyLBkwn8cqljo9pUy1brxNnfZ?usp=sharing)

| Что сделано                                                                                                                                                                                      |   |
|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---|
| В качестве исходных данных взята настоящая видео последовательность из файл в формате YV12, т.е. программа производит поиск и компенсацию движения для всех кадров последовательности (2 балла). | + |
| Распараллелить алгоритм поиска и компенсации движения(2 балла).                                                                                                                                  | + |
| Реализовать простой поиск движения в радиусе 16 пикселей (например полный поиск) (2 балл).                                                                                                       | + |
| Реализовать оптимизированный поиск движения (алгоритм на ваше усмотрение) (3 балла). (Выбрал трехшаговый поиск)                                                                                  | + |
| Реализовать полупиксельный поиск движения дополнительно к основному в радиусе пол пикселя от найденного вектора (3 балла).                                                                       | - |
| Посчитать PSNR метрику двух изображений (1 балла).                                                                                                                                               | + |
| Процедура чтения блока 8х8 из кадра написана на ASM с использованием SIMD инструкций (2 балла).                                                                                                  | - |
| Процедура компенсации написана на ASM с использованием SIMD инструкций (2 балл).                                                                                                                 | - |
| Процедура сравнивания блоков написана на ASM с использованием SIMD инструкций (2 балл).                                                                                                          | - |

#### Примечания
 - Ассемблер успел немного поковырять, но чтобы разобраться с SIMD инструкциями понадобилось бы больше времени, решил сфокусироваться на других задачах.
